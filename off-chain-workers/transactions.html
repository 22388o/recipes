<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Transactions - Substrate Recipes</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A Hands-On Cookbook for Aspiring Blockchain Chefs">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../pallets-intro.html"><strong aria-hidden="true">1.</strong> Pallets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../runtime-printing.html"><strong aria-hidden="true">1.1.</strong> Printing to the Node Log</a></li><li class="chapter-item expanded "><a href="../events.html"><strong aria-hidden="true">1.2.</strong> Emitting Events</a></li><li class="chapter-item expanded "><a href="../storage-maps.html"><strong aria-hidden="true">1.3.</strong> Storage Maps</a></li><li class="chapter-item expanded "><a href="../cache.html"><strong aria-hidden="true">1.4.</strong> Cache Locally &gt; Storage Calls</a></li><li class="chapter-item expanded "><a href="../vec-set.html"><strong aria-hidden="true">1.5.</strong> Using Vectors as Sets</a></li><li class="chapter-item expanded "><a href="../map-set.html"><strong aria-hidden="true">1.6.</strong> Using Maps as Sets</a></li><li class="chapter-item expanded "><a href="../double.html"><strong aria-hidden="true">1.7.</strong> Subgroup Removal by Subkey: Double Maps</a></li><li class="chapter-item expanded "><a href="../structs.html"><strong aria-hidden="true">1.8.</strong> Storing custom structs</a></li><li class="chapter-item expanded "><a href="../ringbuffer.html"><strong aria-hidden="true">1.9.</strong> Ringbuffer Queue</a></li><li class="chapter-item expanded "><a href="../basic-token.html"><strong aria-hidden="true">1.10.</strong> Basic Token</a></li><li class="chapter-item expanded "><a href="../constants.html"><strong aria-hidden="true">1.11.</strong> Configurable Constants</a></li><li class="chapter-item expanded "><a href="../crowdfund.html"><strong aria-hidden="true">1.12.</strong> Simple Crowdfund</a></li><li class="chapter-item expanded "><a href="../instantiable.html"><strong aria-hidden="true">1.13.</strong> Instantiable Pallets</a></li><li class="chapter-item expanded "><a href="../weights.html"><strong aria-hidden="true">1.14.</strong> Weights for Resource Accounting</a></li><li class="chapter-item expanded "><a href="../charity.html"><strong aria-hidden="true">1.15.</strong> Charity and Imbalances</a></li><li class="chapter-item expanded "><a href="../fixed-point.html"><strong aria-hidden="true">1.16.</strong> Fixed Point Arithmetic</a></li><li class="chapter-item expanded "><a href="../off-chain-workers/index.html"><strong aria-hidden="true">1.17.</strong> Off-chain Workers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../off-chain-workers/transactions.html" class="active"><strong aria-hidden="true">1.17.1.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../off-chain-workers/http-json.html"><strong aria-hidden="true">1.17.2.</strong> HTTP Fetching &amp; JSON Parsing</a></li><li class="chapter-item expanded "><a href="../off-chain-workers/storage.html"><strong aria-hidden="true">1.17.3.</strong> Local Storage</a></li></ol></li><li class="chapter-item expanded "><a href="../currency.html"><strong aria-hidden="true">1.18.</strong> Currency Types</a></li><li class="chapter-item expanded "><a href="../currency-imbalances.html"><strong aria-hidden="true">1.19.</strong> Currency and Imbalances</a></li><li class="chapter-item expanded "><a href="../randomness.html"><strong aria-hidden="true">1.20.</strong> Generating Randomness</a></li><li class="chapter-item expanded "><a href="../pallet-coupling.html"><strong aria-hidden="true">1.21.</strong> Tightly- and Loosely-Coupled Pallets</a></li></ol></li><li class="chapter-item expanded "><a href="../runtimes-intro.html"><strong aria-hidden="true">2.</strong> Runtimes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../runtime-api.html"><strong aria-hidden="true">2.1.</strong> Runtime APIs</a></li><li class="chapter-item expanded "><a href="../fees.html"><strong aria-hidden="true">2.2.</strong> Transaction Fees for Economic Security</a></li></ol></li><li class="chapter-item expanded "><a href="../consensus-intro.html"><strong aria-hidden="true">3.</strong> Consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sha3-pow-consensus.html"><strong aria-hidden="true">3.1.</strong> Sha3 Pow Consensus Algorithms</a></li></ol></li><li class="chapter-item expanded "><a href="../nodes-intro.html"><strong aria-hidden="true">4.</strong> Nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kitchen-node.html"><strong aria-hidden="true">4.1.</strong> Kitchen Node - An reusable instant seal node</a></li><li class="chapter-item expanded "><a href="../custom-rpc.html"><strong aria-hidden="true">4.2.</strong> Custom RPCs</a></li><li class="chapter-item expanded "><a href="../basic-pow.html"><strong aria-hidden="true">4.3.</strong> Basic Proof of Work Node</a></li><li class="chapter-item expanded "><a href="../hybrid-consensus.html"><strong aria-hidden="true">4.4.</strong> Hybrid PoW/PoS Consensus Node</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Substrate Recipes</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#transactions-in-off-chain-workers" id="transactions-in-off-chain-workers">Transactions in Off-chain Workers</a></h1>
<p><code>pallets/ocw-demo</code>
<a href="https://playground.substrate.dev/?deploy=recipes&files=%2Fhome%2Fsubstrate%2Fworkspace%2Fpallets%ocw-demo%2Fsrc%2Flib.rs" target="_blank"><img src="https://img.shields.io/badge/Playground-Try%20it!-brightgreen?logo=Parity%20Substrate" alt="Try on playground" /></a>
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs" target="_blank"><img src="https://img.shields.io/badge/Github-View%20Code-brightgreen?logo=github" alt="View on GitHub" /></a></p>
<h2><a class="header" href="#compiling-this-pallet" id="compiling-this-pallet">Compiling this Pallet</a></h2>
<p>This <code>ocw-demo</code> pallet is included in the
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/runtimes/ocw-runtime">ocw-runtime</a>.
In order to use this runtime in the kitchen node, we open the <code>nodes/kitchen-node/Cargo.toml</code> file,
enable the <code>ocw-runtime</code> package and comment out the <code>super-runtime</code> package.</p>
<p>Then we build the kitchen node with <code>ocw</code> feature flag:</p>
<pre><code class="language-bash"># Switch to kitchen-node directory
cd nodes/kitchen-node

# Compile with OCW feature
cargo build --release --features ocw
</code></pre>
<p>With this feature flag, an account key is injected into the Substrate node keystore.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/blob/master/nodes/kitchen-node/src/service.rs"><code>nodes/kitchen-node/src/service.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Initialize seed for signing transaction using off-chain workers
#[cfg(feature = &quot;ocw&quot;)]
{
	keystore.write().insert_ephemeral_from_seed_by_type::&lt;runtime::offchain_demo::crypto::Pair&gt;(
		&quot;//Alice&quot;, runtime::offchain_demo::KEY_TYPE
	).expect(&quot;Creating key with account Alice should succeed.&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#life-cycle-of-off-chain-worker" id="life-cycle-of-off-chain-worker">Life-cycle of Off-chain Worker</a></h2>
<p>Running the <code>kitchen-node</code> you will see log messages similar to the following:</p>
<pre><code>2020-09-02 11:09:33.780 main WARN sc_cli::commands::run_cmd  Running in --dev mode, RPC CORS has been disabled.
2020-09-02 11:09:33.780 main INFO sc_cli::runner  Kitchen Node
2020-09-02 11:09:33.781 main INFO sc_cli::runner  ✌️  version 2.0.0-rc6-unknown-x86_64-linux-gnu
2020-09-02 11:09:33.781 main INFO sc_cli::runner  ❤️  by Substrate DevHub &lt;https://github.com/substrate-developer-hub&gt;, 2019-2020
2020-09-02 11:09:33.781 main INFO sc_cli::runner  📋 Chain specification: Development
2020-09-02 11:09:33.781 main INFO sc_cli::runner  🏷  Node name: precious-angle-3060
2020-09-02 11:09:33.781 main INFO sc_cli::runner  👤 Role: AUTHORITY
2020-09-02 11:09:33.781 main INFO sc_cli::runner  💾 Database: RocksDb at /home/jimmychu/.local/share/kitchen-node/chains/dev/db
2020-09-02 11:09:33.781 main INFO sc_cli::runner  ⛓  Native runtime: ocw-runtime-1 (ocw-runtime-1.tx1.au1)
2020-09-02 11:09:34.881 main INFO sc_service::client::client  🔨 Initializing Genesis block/state (state: 0x2b24…4bf9, header-hash: 0xde55…8fed)
2020-09-02 11:09:35.081 main WARN sc_service::builder  Using default protocol ID &quot;sup&quot; because none is configured in the chain specs
2020-09-02 11:09:35.083 main INFO sub-libp2p  🏷  Local node identity is: 12D3KooWC8iNnJqM64qiurVSA3mRFGE4LPj99QPVtUE6whyxFAJy (legacy representation: QmZPmiuc4DAmM7Fo6GdChmxF4pTaDc8brgUKVXLhxKjq62)
2020-09-02 11:09:35.517 main INFO sc_service::builder  📦 Highest known block at #0
2020-09-02 11:09:35.519 tokio-runtime-worker INFO substrate_prometheus_endpoint::known_os  〽️ Prometheus server started at 127.0.0.1:9615
2020-09-02 11:09:40.527 tokio-runtime-worker INFO substrate  💤 Idle (0 peers), best: #0 (0xde55…8fed), finalized #0 (0xde55…8fed), ⬇ 0 ⬆ 0
...
</code></pre>
<p>First, pay attention the line <code>⛓  Native runtime: ocw-runtime-1 (ocw-runtime-1.tx1.au1)</code>
to ensure we are running the kitchen-node with the <code>ocw-runtime</code>.</p>
<p>Other than that, you will realized the chain is just sitting idled. This is because currently off-chain
worker is only run after a block is imported. Our kitchen node is configured to use
<a href="../kitchen-node.html">instant-seal consensus</a>, meaning that we need to send a transaction to trigger a
block to be imported.</p>
<p>Once a transaction is sent, such as using <a href="https://polkadot.js.org/apps?rpc=ws://localhost:9944">Polkadot-JS App</a>
to perform a balance transfer, the following more interesting logs are shown.</p>
<pre><code>2020-09-03 23:47:24.656 tokio-runtime-worker INFO sc_consensus_manual_seal::rpc  Instant Seal success: CreatedBlock { hash: 0x02f2fd8e06bd8138040813f18c4b2df41404c289c3418142f613ae5c72abe6ce, aux: ImportedAux { header_only: false, clear_justification_requests: false, needs_justification: false, bad_justification: false, needs_finality_proof: false, is_new_best: true } }
2020-09-03 23:47:24.658  INFO ocw_demo  Entering off-chain worker
2020-09-03 23:47:24.866 tokio-runtime-worker INFO sc_basic_authorship::basic_authorship  🙌 Starting consensus session on top of parent 0x02f2fd8e06bd8138040813f18c4b2df41404c289c3418142f613ae5c72abe6ce
2020-09-03 23:47:24.874 tokio-blocking-driver INFO ocw_demo  submit_number_signed: (0, d43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d (5GrwvaEF...))
2020-09-03 23:47:24.874 tokio-blocking-driver INFO ocw_demo  Number vector: [0]
...
</code></pre>
<p>Let's take a deeper look at what's happening here. Referring to the code at
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a>,
there is an <code>fn offchain_worker()</code> function inside <code>decl_module!</code>. This is the entry point of the
off-chain worker logic which is executed once per block import.</p>
<p>As off-chain workers, by definition, run computation off-chain, they cannot alter the block state
directly. In order to do so, they need to send transactions back on-chain. Three kinds of transaction
can be sent here, <strong>signed transactions</strong>, <strong>unsigned transactions</strong>, and <strong>unsigned transactions
with signed payload</strong>.</p>
<ul>
<li><a href="#signed-transactions">Signed transactions</a> are used if the transaction requires the sender to be
specified.</li>
<li><a href="#unsigned-transactions">Unsigned transactions</a> are used when the sender does not need to be known.</li>
<li><a href="#unsigned-transactions-with-signed-payloads">Unsigned transactions with signed payloads</a> are used
if the transaction requires the sender to be specified but the sender account not be charged for the transaction fee.</li>
</ul>
<p>We will walk through each of them in the following.</p>
<h2><a class="header" href="#signed-transactions" id="signed-transactions">Signed Transactions</a></h2>
<blockquote>
<p><strong>Notes</strong>: This example will have account <code>Alice</code> submitting signed transactions to the node in
the off-chain worker, and these transactions have associated fees. If you run the node in development
mode (with <code>--dev</code> flag) using the default sr25519 crypto signature, <code>Alice</code> will have sufficient funds
initialized in the chain and this example will run fine. Otherwise, please be aware <code>Alice</code> account
must be funded to run this example.</p>
</blockquote>
<h3><a class="header" href="#setup" id="setup">Setup</a></h3>
<p>For signed transactions, we have to define a crypto signature sub-module:</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub const KEY_TYPE: KeyTypeId = KeyTypeId(*b&quot;demo&quot;);

pub mod crypto {
	use crate::KEY_TYPE;
	use sp_runtime::app_crypto::{app_crypto, sr25519};
	// -- snip --
	app_crypto!(sr25519, KEY_TYPE);
}
<span class="boring">}
</span></code></pre></pre>
<p><code>KEY_TYPE</code> is the application key prefix for the pallet in the underlying storage. This is to be used
for signing transactions.</p>
<p>Second, we have our pallet configration trait be additionally bounded by <code>CreateSignedTransaction</code>
and add an additional associated type <code>AuthorityId</code>. This tell the runtime that this pallet can
create signed transactions.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Trait: system::Trait + CreateSignedTransaction&lt;Call&lt;Self&gt;&gt; {
	/// The identifier type for an offchain worker.
	type AuthorityId: AppCrypto&lt;Self::Public, Self::Signature&gt;;
	// -- snip --
}
<span class="boring">}
</span></code></pre></pre>
<p>Now if we <a href="#compiling-this-pallet">build the <code>kitchen-node</code></a>, we will see compiler errors saying
three trait bounds are not satisfied: <code>Runtime: frame_system::offchain::CreateSignedTransaction</code>,
<code>frame_system::offchain::SigningTypes</code>, and <code>frame_system::offchain::SendTransactionTypes</code>. So let's
implement these traits in our runtime.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/runtimes/ocw-runtime/src/lib.rs"><code>runtimes/ocw-runtime/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;LocalCall&gt; frame_system::offchain::CreateSignedTransaction&lt;LocalCall&gt; for Runtime
where
	Call: From&lt;LocalCall&gt;,
{
	fn create_transaction&lt;C: frame_system::offchain::AppCrypto&lt;Self::Public, Self::Signature&gt;&gt;(
		call: Call,
		public: &lt;Signature as sp_runtime::traits::Verify&gt;::Signer,
		account: AccountId,
		index: Index,
	) -&gt; Option&lt;(
		Call,
		&lt;UncheckedExtrinsic as sp_runtime::traits::Extrinsic&gt;::SignaturePayload,
	)&gt; {
		let period = BlockHashCount::get() as u64;
		let current_block = System::block_number()
			.saturated_into::&lt;u64&gt;()
			.saturating_sub(1);
		let tip = 0;
		let extra: SignedExtra = (
			frame_system::CheckTxVersion::&lt;Runtime&gt;::new(),
			frame_system::CheckGenesis::&lt;Runtime&gt;::new(),
			frame_system::CheckEra::&lt;Runtime&gt;::from(generic::Era::mortal(period, current_block)),
			frame_system::CheckNonce::&lt;Runtime&gt;::from(index),
			frame_system::CheckWeight::&lt;Runtime&gt;::new(),
			pallet_transaction_payment::ChargeTransactionPayment::&lt;Runtime&gt;::from(tip),
		);

		#[cfg_attr(not(feature = &quot;std&quot;), allow(unused_variables))]
		let raw_payload = SignedPayload::new(call, extra)
			.map_err(|e| {
				debug::native::warn!(&quot;SignedPayload error: {:?}&quot;, e);
			})
			.ok()?;

		let signature = raw_payload.using_encoded(|payload| C::sign(payload, public))?;

		let address = account;
		let (call, extra, _) = raw_payload.deconstruct();
		Some((call, (address, signature, extra)))
	}
}
<span class="boring">}
</span></code></pre></pre>
<p>The overall goal here is to perform the following:</p>
<ul>
<li>Signing the on-chain <code>call</code> and <code>extra</code> payload of the call. This together is called the signature.</li>
<li>Finally returning the on-chain <code>call</code>, the account/address making the signature, the signature
itself, and the <code>extra</code> payload.</li>
</ul>
<p>The <code>SignedExtra</code> data type used above is defined later in our runtime.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/runtimes/ocw-runtime/src/lib.rs"><code>runtimes/ocw-runtime/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// The SignedExtension to the basic transaction logic.
pub type SignedExtra = (
	frame_system::CheckSpecVersion&lt;Runtime&gt;,
	frame_system::CheckTxVersion&lt;Runtime&gt;,
	frame_system::CheckGenesis&lt;Runtime&gt;,
	frame_system::CheckEra&lt;Runtime&gt;,
	frame_system::CheckNonce&lt;Runtime&gt;,
	frame_system::CheckWeight&lt;Runtime&gt;,
	pallet_transaction_payment::ChargeTransactionPayment&lt;Runtime&gt;,
);
<span class="boring">}
</span></code></pre></pre>
<p>Next the remaining two traits are also implemented by specifying the concrete types of their respective
trait associated types.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/runtimes/ocw-runtime/src/lib.rs"><code>runtimes/ocw-runtime/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl frame_system::offchain::SigningTypes for Runtime {
	type Public = &lt;Signature as sp_runtime::traits::Verify&gt;::Signer;
	type Signature = Signature;
}

impl&lt;C&gt; frame_system::offchain::SendTransactionTypes&lt;C&gt; for Runtime
where
	Call: From&lt;C&gt;,
{
	type OverarchingCall = Call;
	type Extrinsic = UncheckedExtrinsic;
}
<span class="boring">}
</span></code></pre></pre>
<p>By now, we have completed the setup of implementing the necessary trait bounds for our runtime to
create signed transactions.</p>
<h3><a class="header" href="#sending-signed-transactions" id="sending-signed-transactions">Sending Signed Transactions</a></h3>
<p>A signed transaction is sent with <code>frame_system::offchain::SendSignedTransaction::send_signed_transaction</code>,
as shown below:</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn offchain_signed_tx(block_number: T::BlockNumber) -&gt; Result&lt;(), Error&lt;T&gt;&gt; {
	// We retrieve a signer and check if it is valid.
	//   Since this pallet only has one key in the keystore. We use `any_account()1 to
	//   retrieve it. If there are multiple keys and we want to pinpoint it, `with_filter()` can be chained,
	//   ref: https://substrate.dev/rustdocs/v2.0.0/frame_system/offchain/struct.Signer.html
	let signer = Signer::&lt;T, T::AuthorityId&gt;::any_account();

	// Translating the current block number to number and submit it on-chain
	let number: u64 = block_number.try_into().unwrap_or(0) as u64;

	// `result` is in the type of `Option&lt;(Account&lt;T&gt;, Result&lt;(), ()&gt;)&gt;`. It is:
	//   - `None`: no account is available for sending transaction
	//   - `Some((account, Err(())))`: error occured when sending the transaction
	//   - `Some((account, Ok(())))`: transaction is successfully sent
	let result = signer.send_signed_transaction(|_acct|
		// This is the on-chain function
		Call::submit_number_signed(number)
	);

	// Display error if the signed tx fails.
	if let Some((acc, res)) = result {
		if res.is_err() {
			debug::error!(&quot;failure: offchain_signed_tx: tx sent: {:?}&quot;, acc.id);
			return Err(&lt;Error&lt;T&gt;&gt;::OffchainSignedTxError);
		}
		// Transaction is sent successfully
		return Ok(());
	}

	// The case of `None`: no account is available for sending
	debug::error!(&quot;No local account available&quot;);
	Err(&lt;Error&lt;T&gt;&gt;::NoLocalAcctForSignedTx)
}
<span class="boring">}
</span></code></pre></pre>
<p>On the above code, we first retrieve a signer. Then we send a signed transaction on-chain by calling
<code>send_signed_transaction</code> with a closure returning the on-chain call,
<code>Call::submit_number_signed(submission)</code>.</p>
<p>Then we use the signer to send signed transaction, and the result is in the type of
<code>Option&lt;(Account&lt;T&gt;, Result&lt;(), ()&gt;)&gt;</code>. So we handle each of the following cases:</p>
<ul>
<li><code>None</code>: when no account is available for sending transaction</li>
<li><code>Some((account, Err(())))</code>: when an error occured when sending the transaction</li>
<li><code>Some((account, Ok(())))</code>: when transaction is successfully sent</li>
</ul>
<p>Eventually, the <code>call</code> transaction is made on-chain via the
<code>frame_system::offchain::CreateSignedTransaction::create_transaction</code> function we defined in our
runtime.</p>
<h2><a class="header" href="#unsigned-transactions" id="unsigned-transactions">Unsigned Transactions</a></h2>
<h3><a class="header" href="#setup-1" id="setup-1">Setup</a></h3>
<p>By default unsigned transactions are rejected by the runtime unless they are explicitly
allowed. So we write the logic to allow unsigned transactions to be validated:</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T: Trait&gt; frame_support::unsigned::ValidateUnsigned for Module&lt;T&gt; {
	type Call = Call&lt;T&gt;;

	fn validate_unsigned(_source: TransactionSource, call: &amp;Self::Call) -&gt; TransactionValidity {
		let valid_tx = |provide| ValidTransaction::with_tag_prefix(&quot;ocw-demo&quot;)
			.priority(T::UnsignedPriority::get())
			.and_provides([&amp;provide])
			.longevity(3)
			.propagate(true)
			.build();

		match call {
			Call::submit_number_unsigned(_number) =&gt; valid_tx(b&quot;submit_number_unsigned&quot;.to_vec()),
			// -- snip --
			_ =&gt; InvalidTransaction::Call.into(),
		}
	}
}
<span class="boring">}
</span></code></pre></pre>
<p>We implement the <code>ValidateUnsigned</code> trait for <code>Module</code>, and add the allowance logic inside the
<code>validate_unsigned</code> function. We verify that if the call is <code>Call::submit_number_unsigned</code> we return
a <a href="https://substrate.dev/rustdocs/v2.0.0/sp_runtime/transaction_validity/struct.ValidTransaction.html"><code>ValidTransaction</code></a> object using the <a href="https://github.com/rust-unofficial/patterns/blob/master/patterns/builder.md">builder pattern</a>.</p>
<p>The <code>ValidTransaction</code> object contain some fields we have not seen before:</p>
<ul>
<li><code>priority</code>: determine the ordering of two transactions, given their dependencies are satisfied.</li>
<li><code>requires</code>: contain a list of tags the transaction depends on.</li>
<li><code>provides</code>: contain a list of tags provided by this transaction. Successfully importing the
transaction will enable other transactions that depend on these tags be included. Both<code>provides</code>
and <code>requires</code> tags allow Substrate to build a dependency graph of transactions and import them in
the right order.</li>
<li><code>longevity</code>: this transaction longevity describes the minimum number of blocks the transaction
has to be valid for. After this period the transaction should be removed from the pool or revalidated.</li>
<li><code>propagate</code>: indicate if the transaction should be propagated to other peers. By setting to
<code>false</code> the transaction will still be considered for inclusion in blocks on
the current node but will never be sent to other peers.</li>
</ul>
<p>Finally, to tell the runtime that we have our own <code>ValidateUnsigned</code> logic, we need to pass
this as a parameter when constructing the runtime:</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/runtimes/ocw-runtime/src/lib.rs"><code>runtimes/ocw-runtime/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>construct_runtime!(
	pub enum Runtime where
		Block = Block,
		NodeBlock = opaque::Block,
		UncheckedExtrinsic = UncheckedExtrinsic
	{
		//...snip
		OcwDemo: ocw_demo::{Module, Call, Storage, Event&lt;T&gt;, ValidateUnsigned},
	}
);
<span class="boring">}
</span></code></pre></pre>
<h3><a class="header" href="#sending-unsigned-transactions" id="sending-unsigned-transactions">Sending Unsigned Transactions</a></h3>
<p>We can now send an unsigned transaction from offchain worker with the
<code>T::SubmitUnsignedTransaction::submit_unsigned</code> function, as shown in the code.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn offchain_unsigned_tx(block_number: T::BlockNumber) -&gt; Result&lt;(), Error&lt;T&gt;&gt; {
	let number: u64 = block_number.try_into().unwrap_or(0) as u64;
	let call = Call::submit_number_unsigned(number);

	// `submit_unsigned_transaction` returns a type of `Result&lt;(), ()&gt;`
	//   ref: https://substrate.dev/rustdocs/v2.0.0/frame_system/offchain/struct.SubmitTransaction.html#method.submit_unsigned_transaction
	SubmitTransaction::&lt;T, Call&lt;T&gt;&gt;::submit_unsigned_transaction(call.into())
		.map_err(|_| {
			debug::error!(&quot;Failed in offchain_unsigned_tx&quot;);
			&lt;Error&lt;T&gt;&gt;::OffchainUnsignedTxError
		})
}
<span class="boring">}
</span></code></pre></pre>
<p>As in signed transactions, we prepare a function reference with its parameters and call
<a href="https://substrate.dev/rustdocs/v2.0.0/frame_system/offchain/struct.SubmitTransaction.html#method.submit_unsigned_transaction"><code>frame_system::offchain::SubmitTransaction::submit_unsigned_transaction</code></a>.</p>
<h2><a class="header" href="#unsigned-transactions-with-signed-payloads" id="unsigned-transactions-with-signed-payloads">Unsigned Transactions with Signed Payloads</a></h2>
<p>With this type of transaction, we need to first specify a signer, sign the transaction, and then send
it back on-chain as unsigned transaction. The main difference with signed transactions is that the signer
account will not be charged for the transaction fee. This is not the case for signed transaction normally.</p>
<p>But this could potentially be an attack vector, so extra precaution should be added as to what counted
as a valid (unsigned) transaction.</p>
<p>Since we are still sending unsigned transactions, we need to add extra code to validate them. <a href="#setup-1">See above</a>.</p>
<h3><a class="header" href="#sending-unsigned-transactions-with-signed-payloads" id="sending-unsigned-transactions-with-signed-payloads">Sending Unsigned Transactions with Signed Payloads</a></h3>
<p>We send unsigned transactions with signed payloads as followed.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn offchain_unsigned_tx_signed_payload(block_number: T::BlockNumber) -&gt; Result&lt;(), Error&lt;T&gt;&gt; {
	// Retrieve the signer to sign the payload
	let signer = Signer::&lt;T, T::AuthorityId&gt;::any_account();

	let number: u64 = block_number.try_into().unwrap_or(0) as u64;

	// `send_unsigned_transaction` is returning a type of `Option&lt;(Account&lt;T&gt;, Result&lt;(), ()&gt;)&gt;`.
	//   Similar to `send_signed_transaction`, they account for:
	//   - `None`: no account is available for sending transaction
	//   - `Some((account, Ok(())))`: transaction is successfully sent
	//   - `Some((account, Err(())))`: error occured when sending the transaction
	if let Some((_, res)) = signer.send_unsigned_transaction(
		|acct| Payload { number, public: acct.public.clone() },
		Call::submit_number_unsigned_with_signed_payload
	) {
		return res.map_err(|_| {
			debug::error!(&quot;Failed in offchain_unsigned_tx_signed_payload&quot;);
			&lt;Error&lt;T&gt;&gt;::OffchainUnsignedTxSignedPayloadError
		});
	}

	// The case of `None`: no account is available for sending
	debug::error!(&quot;No local account available&quot;);
	Err(&lt;Error&lt;T&gt;&gt;::NoLocalAcctForSigning)
}
<span class="boring">}
</span></code></pre></pre>
<p>What is unique here is that
<a href="https://substrate.dev/rustdocs/v2.0.0/frame_system/offchain/trait.SendUnsignedTransaction.html#tymethod.send_unsigned_transaction"><code>send_unsigned_transaction</code> function</a> takes two functions. The first, expressed as a closure,
returns a <code>SignedPayload</code> object, and the second returns an on-chain call to be made.</p>
<p>We have defined our <code>SignedPayload</code> object earlier in the pallet.</p>
<p>src:
<a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/ocw-demo/src/lib.rs"><code>pallets/ocw-demo/src/lib.rs</code></a></p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug)]
pub struct Payload&lt;Public&gt; {
	number: u64,
	public: Public
}

impl &lt;T: SigningTypes&gt; SignedPayload&lt;T&gt; for Payload&lt;T::Public&gt; {
	fn public(&amp;self) -&gt; T::Public {
		self.public.clone()
	}
}
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#conclusion" id="conclusion">Conclusion</a></h2>
<p>By now, you should be able to code your own off-chain workers that send signed transactions, unsigned
transactions, and unsigned transactions with signed payloads back on chain.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../off-chain-workers/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../off-chain-workers/http-json.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../off-chain-workers/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../off-chain-workers/http-json.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../.analytics/load.js"></script>
        
        <script type="text/javascript" src="../.analytics/config.js"></script>
        
        <script type="text/javascript" src="../.analytics/klaro.min.js"></script>
        

        

    </body>
</html>
