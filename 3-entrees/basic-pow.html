<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Basic Proof of Work - Substrate Recipes</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A Hands-On Cookbook for Aspiring Blockchain Chefs">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../introduction.html">Introduction</a></li><li class="expanded "><a href="../1-prepare-kitchen/index.html"><strong aria-hidden="true">1.</strong> Preparing Your Kitchen</a></li><li><ol class="section"><li class="expanded "><a href="../1-prepare-kitchen/1-build-node.html"><strong aria-hidden="true">1.1.</strong> Building A Node</a></li><li class="expanded "><a href="../1-prepare-kitchen/2-interact-node.html"><strong aria-hidden="true">1.2.</strong> Interacting with a Node</a></li><li class="expanded "><a href="../1-prepare-kitchen/3-kitchen-organization.html"><strong aria-hidden="true">1.3.</strong> Kitchen Organization</a></li></ol></li><li class="expanded "><a href="../2-appetizers/index.html"><strong aria-hidden="true">2.</strong> Appetizers</a></li><li><ol class="section"><li class="expanded "><a href="../2-appetizers/1-hello-substrate.html"><strong aria-hidden="true">2.1.</strong> Hello Substrate</a></li><li class="expanded "><a href="../2-appetizers/2-storage-values.html"><strong aria-hidden="true">2.2.</strong> Single Value Storage</a></li><li class="expanded "><a href="../2-appetizers/3-errors.html"><strong aria-hidden="true">2.3.</strong> Handling Errors</a></li><li class="expanded "><a href="../2-appetizers/4-events.html"><strong aria-hidden="true">2.4.</strong> Events Verify Execution</a></li></ol></li><li class="expanded "><a href="../3-entrees/index.html"><strong aria-hidden="true">3.</strong> Entrees</a></li><li><ol class="section"><li class="expanded "><a href="../3-entrees/storage-api/index.html"><strong aria-hidden="true">3.1.</strong> Runtime Storage API</a></li><li><ol class="section"><li class="expanded "><a href="../3-entrees/storage-api/storage-maps.html"><strong aria-hidden="true">3.1.1.</strong> Storage Maps</a></li><li class="expanded "><a href="../3-entrees/storage-api/cache.html"><strong aria-hidden="true">3.1.2.</strong> Cache Locally &gt; Storage Calls</a></li><li class="expanded "><a href="../3-entrees/storage-api/sets-vecs-iteration.html"><strong aria-hidden="true">3.1.3.</strong> Sets, Vectors, Iteration</a></li><li class="expanded "><a href="../3-entrees/storage-api/double.html"><strong aria-hidden="true">3.1.4.</strong> Subgroup Removal by Subkey: Double Maps</a></li><li class="expanded "><a href="../3-entrees/storage-api/childtries.html"><strong aria-hidden="true">3.1.5.</strong> Efficient Subgroup Removal by Subkey: Child Tries</a></li><li class="expanded "><a href="../3-entrees/storage-api/structs.html"><strong aria-hidden="true">3.1.6.</strong> Storing custom structs</a></li><li class="expanded "><a href="../3-entrees/storage-api/ringbuffer.html"><strong aria-hidden="true">3.1.7.</strong> Ringbuffer Queue</a></li></ol></li><li class="expanded "><a href="../3-entrees/basic-token.html"><strong aria-hidden="true">3.2.</strong> Basic Token</a></li><li class="expanded "><a href="../3-entrees/constants.html"><strong aria-hidden="true">3.3.</strong> Configurable Constants</a></li><li class="expanded "><a href="../3-entrees/instantiable.html"><strong aria-hidden="true">3.4.</strong> Instantiable Pallets</a></li><li class="expanded "><a href="../3-entrees/weights.html"><strong aria-hidden="true">3.5.</strong> Weights for Resource Accounting</a></li><li class="expanded "><a href="../3-entrees/fees.html"><strong aria-hidden="true">3.6.</strong> Transaction Fees for Economic Security</a></li><li class="expanded "><a href="../3-entrees/charity.html"><strong aria-hidden="true">3.7.</strong> Charity and Imbalances</a></li><li class="expanded "><a href="../3-entrees/fixed-point.html"><strong aria-hidden="true">3.8.</strong> Fixed Point Arithmetic</a></li><li class="expanded "><a href="../3-entrees/off-chain-workers/index.html"><strong aria-hidden="true">3.9.</strong> Off-chain Workers</a></li><li><ol class="section"><li class="expanded "><a href="../3-entrees/off-chain-workers/transactions.html"><strong aria-hidden="true">3.9.1.</strong> Transactions</a></li><li class="expanded "><a href="../3-entrees/off-chain-workers/http-json.html"><strong aria-hidden="true">3.9.2.</strong> HTTP Fetching &amp; JSON Parsing</a></li><li class="expanded "><a href="../3-entrees/off-chain-workers/storage.html"><strong aria-hidden="true">3.9.3.</strong> Local Storage</a></li></ol></li><li class="expanded "><a href="../3-entrees/runtime-api.html"><strong aria-hidden="true">3.10.</strong> Runtime APIs</a></li><li class="expanded "><a href="../3-entrees/custom-rpc.html"><strong aria-hidden="true">3.11.</strong> Custom RPCs</a></li><li class="expanded "><a href="../3-entrees/basic-pow.html" class="active"><strong aria-hidden="true">3.12.</strong> Basic Proof of Work</a></li><li class="expanded "><a href="../3-entrees/manual-seal.html"><strong aria-hidden="true">3.13.</strong> Manual Seal Consensus</a></li><li class="expanded "><a href="../3-entrees/currency.html"><strong aria-hidden="true">3.14.</strong> Currency Types</a></li><li class="expanded "><a href="../3-entrees/randomness.html"><strong aria-hidden="true">3.15.</strong> Generating Randomness</a></li><li class="expanded "><a href="../3-entrees/execution-schedule.html"><strong aria-hidden="true">3.16.</strong> Execution Schedule</a></li><li class="expanded "><a href="../3-entrees/permissioned-methods.html"><strong aria-hidden="true">3.17.</strong> Permissioned Methods</a></li><li class="expanded "><a href="../3-entrees/testing/index.html"><strong aria-hidden="true">3.18.</strong> Testing</a></li><li><ol class="section"><li class="expanded "><a href="../3-entrees/testing/mock.html"><strong aria-hidden="true">3.18.1.</strong> Basic Test Environments</a></li><li class="expanded "><a href="../3-entrees/testing/common.html"><strong aria-hidden="true">3.18.2.</strong> Common Tests</a></li><li class="expanded "><a href="../3-entrees/testing/off-chain-workers.html"><strong aria-hidden="true">3.18.3.</strong> Off-chain Worker Test Environment</a></li><li class="expanded "><a href="../3-entrees/testing/externalities.html"><strong aria-hidden="true">3.18.4.</strong> Custom Test Environment</a></li></ol></li><li class="expanded "><a href="../3-entrees/safemath.html"><strong aria-hidden="true">3.19.</strong> Safe Math</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="../more-resources.html">More Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Substrate Recipes</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#basic-proof-of-work" id="basic-proof-of-work">Basic Proof of Work</a></h1>
<p><em><a href="https://github.com/substrate-developer-hub/recipes/tree/master/nodes/basic-pow"><code>nodes/basic-pow</code></a></em></p>
<p>The <code>basic-pow</code> node uses a minimal <a href="https://en.wikipedia.org/wiki/Proof_of_work">Proof of Work</a> consensus engine to reach agreement over the blockchain. This node is kept intentionally simple. It omits some features that make Proof of Work practical for real-world use such as difficulty adjustment and block rewards. Nonetheless, it is a real usable consensus engine that will teach us many useful aspects of dealing with consensus and prepare us to understand more advanced consensus engines in the future. In particular we will learn about:</p>
<ul>
<li>Substrate's <a href="https://substrate.dev/rustdocs/master/sp_consensus/block_import/trait.BlockImport.html"><code>BlockImport</code> trait</a></li>
<li>Substrate's <a href="https://substrate.dev/rustdocs/master/sp_consensus/import_queue/index.html">import pipeline</a></li>
<li>Structure of a typical <a href="https://substrate.dev/rustdocs/master/sc_service/index.html">Substrate Service</a></li>
<li>Configuration of <a href="https://substrate.dev/rustdocs/master/sp_authorship/struct.InherentDataProvider.html"><code>InherentDataProvider</code></a>s</li>
</ul>
<h2><a class="header" href="#the-structure-of-a-node" id="the-structure-of-a-node">The Structure of a Node</a></h2>
<p>You may remember from the <a href="../2-appetizers/1-hello-substrate.html">hello-substrate recipe</a> that a Substrate node has two parts. An outer part that is responsible for gossiping transactions and blocks, handling <a href="./custom-rpc.html">rpc requests</a>, and reaching consensus. And a runtime that is responsible for the business logic of the chain. This architecture diagram illustrates the distinction.</p>
<p><img src="../img/substrate-architecture.png" alt="Substrate Architecture Diagram" /></p>
<p>In principle the consensus engine, part of the outer node, is agnostic over the runtime that is used with it. But in practice, most consensus engines will require the runtime to provide certain <a href="./runtime-api.html">runtime APIs</a> that affect the engine. For example, Aura and Babe query the runtime for the set of validators. A more real-world PoW consensus would query the runtime for the block difficulty. Additionally, some runtimes rely on the consensus engine to provide <a href="https://substrate.dev/rustdocs/master/sp_runtime/generic/enum.DigestItem.html#variant.PreRuntime">pre-runtime digests</a>. For example, runtimes that include the Babe pallet expect a pre-runtime digest containing information about the current babe slot. Because of these requirements, this node will use a dedicated <code>pow-runtime</code>. The contents of that runtime should be familiar, and will not be discussed here.</p>
<h2><a class="header" href="#proof-of-work-algorithms" id="proof-of-work-algorithms">Proof of Work Algorithms</a></h2>
<p>Proof of work is not a single consensus algorithm. Rather it is a class of algorithms represented by the <a href="https://substrate.dev/rustdocs/master/sc_consensus_pow/trait.PowAlgorithm.html"><code>PowAlgorithm</code> trait</a>. Before we can build a PoW node we must specify a concrete PoW algorithm by implementing this trait. We specify our algorithm in the <code>pow.rs</code> file.</p>
<pre><code class="language-rust ignore">/// A concrete PoW Algorithm that uses Sha3 hashing.
#[derive(Clone)]
pub struct Sha3Algorithm;
</code></pre>
<p>We will use the <a href="https://en.wikipedia.org/wiki/SHA-3">sha3 hashing algorithm</a>, which we have indicated in the name of our struct. Because this is a <em>minimal</em> PoW algorithm, our struct can also be quite simple. In fact, it is a <a href="https://doc.rust-lang.org/rust-by-example/custom_types/structs.html">unit struct</a>. A more complex PoW algorithm that interfaces with the runtime would need to hold a reference to the client. An example of this (on an older Substrate codebase) can be seen in <a href="https://github.com/kulupu/kulupu/">Kulupu</a>'s <a href="https://github.com/kulupu/kulupu/blob/3500b7f62fdf90be7608b2d813735a063ad1c458/pow/src/lib.rs#L137-L145">RandomXAlgorithm</a>.</p>
<h3><a class="header" href="#difficulty" id="difficulty">Difficulty</a></h3>
<p>The first fucntion we must provide returns the difficulty of the next block to be mined. In our basic PoW, this function is quite simple. The difficulty is fixed. This means that as more mining power joins the network, the block time will become faster.</p>
<pre><code class="language-rust ignore">impl&lt;B: BlockT&lt;Hash=H256&gt;&gt; PowAlgorithm&lt;B&gt; for Sha3Algorithm {
	type Difficulty = U256;

	fn difficulty(&amp;self, _parent: &amp;BlockId&lt;B&gt;) -&gt; Result&lt;Self::Difficulty, Error&lt;B&gt;&gt; {
		// This basic PoW uses a fixed difficulty.
		// Raising this difficulty will make the block time slower.
		Ok(U256::from(1_000_000))
	}

	// --snip--
}
</code></pre>
<h3><a class="header" href="#verification" id="verification">Verification</a></h3>
<p>Our PoW algorithm must also be able to verify blocks provided by other authors. We are first given the pre-hash, which is a hash of the block before the proof of work seal is attached. We are also given the seal, which testifies that the work has been done, and the difficulty that the block author needed to meet. This function first confirms that the provided seal actually meets the target difficulty, then it confirms that the seal is actually valid for the given pre-hash.</p>
<pre><code class="language-rust ignore">fn verify(
	&amp;self,
	_parent: &amp;BlockId&lt;B&gt;,
	pre_hash: &amp;H256,
	seal: &amp;RawSeal,
	difficulty: Self::Difficulty
) -&gt; Result&lt;bool, Error&lt;B&gt;&gt; {
	// Try to construct a seal object by decoding the raw seal given
	let seal = match Seal::decode(&amp;mut &amp;seal[..]) {
		Ok(seal) =&gt; seal,
		Err(_) =&gt; return Ok(false),
	};

	// See whether the hash meets the difficulty requirement. If not, fail fast.
	if !hash_meets_difficulty(&amp;seal.work, difficulty) {
		return Ok(false)
	}

	// Make sure the provided work actually comes from the correct pre_hash
	let compute = Compute {
		difficulty,
		pre_hash: *pre_hash,
		nonce: seal.nonce,
	};

	if compute.compute() != seal {
		return Ok(false)
	}

	Ok(true)
}
</code></pre>
<h3><a class="header" href="#mining" id="mining">Mining</a></h3>
<p>Finally our proof of work algorithm needs to be able to mine blocks of our own.</p>
<pre><code class="language-rust ignore">fn mine(
	&amp;self,
	_parent: &amp;BlockId&lt;B&gt;,
	pre_hash: &amp;H256,
	difficulty: Self::Difficulty,
	round: u32 // The number of nonces to try during this call
) -&gt; Result&lt;Option&lt;RawSeal&gt;, Error&lt;B&gt;&gt; {
	// Get a randomness source from the environment; fail if one isn't available
	let mut rng = SmallRng::from_rng(&amp;mut thread_rng())
		.map_err(|e| Error::Environment(format!(&quot;Initialize RNG failed for mining: {:?}&quot;, e)))?;

	// Loop the specified number of times
	for _ in 0..round {

		// Choose a new nonce
		let nonce = H256::random_using(&amp;mut rng);

		// Calculate the seal
		let compute = Compute {
			difficulty,
			pre_hash: *pre_hash,
			nonce,
		};
		let seal = compute.compute();

		// If we solved the PoW then return, otherwise loop again
		if hash_meets_difficulty(&amp;seal.work, difficulty) {
			return Ok(Some(seal.encode()))
		}
	}

	// Tried the specified number of rounds and never found a solution
	Ok(None)
}
</code></pre>
<p>Notice that this function takes a parameter for the number of rounds of mining it should attempt. If no block has been successfully mined in this time, the method will return. This gives the service a chance to check whether any new blocks have been received from other authors since the mining started. If a valid block has been received, then we will start mining on it. If no such block has been received, we will go in for another try at mining on the same block as before.</p>
<h2><a class="header" href="#the-service-builder" id="the-service-builder">The Service Builder</a></h2>
<p>The <a href="https://substrate.dev/rustdocs/master/sc_service/trait.AbstractService.html">Substrate Service</a> is the main coordinator of the various parts of a Substrate node, including consensus. The service is large and takes many parameters, so it is built with a <a href="https://substrate.dev/rustdocs/master/sc_service/struct.ServiceBuilder.html">ServiceBuilder</a> following <a href="https://doc.rust-lang.org/1.0.0/style/ownership/builders.html">Rust's builder pattern</a>.</p>
<p>The particular builder method that is relevant here is <a href="https://substrate.dev/rustdocs/master/sc_service/struct.ServiceBuilder.html#method.with_import_queue"><code>with_import_queue</code></a>. Here we construct an instance of the <a href="https://substrate.dev/rustdocs/master/sc_consensus_pow/struct.PowBlockImport.html"><code>PowBlockImport</code> struct</a>, providing it with references to our client, our Sha3Algorithm, and some other necessary data.</p>
<pre><code class="language-rust ignore">builder
	.with_import_queue(|_config, client, select_chain, _transaction_pool| {

		let pow_block_import = sc_consensus_pow::PowBlockImport::new(
			client.clone(),
			client.clone(),
			crate::pow::Sha3Algorithm,
			0, // check inherents starting at block 0
			select_chain,
			inherent_data_providers.clone(),
		);

		let import_queue = sc_consensus_pow::import_queue(
			Box::new(pow_block_import.clone()),
			crate::pow::Sha3Algorithm,
			inherent_data_providers.clone(),
		)?;

		import_setup = Some(pow_block_import);

		Ok(import_queue)
	})?;
</code></pre>
<p>Once the <code>PowBlockImport</code> is constructed, we can use it to create an actual import queue that the service will use for importing blocks into the client.</p>
<h3><a class="header" href="#the-block-import-pipeline" id="the-block-import-pipeline">The Block Import Pipeline</a></h3>
<p>You may have noticed that when we created the <code>PowBlockImport</code> we gave it two separate references to the client. The second reference will always be to a client. But the first is interesting. The rustdocs tell us that the first parameter is <code>inner: BlockImport&lt;B, Transaction = TransactionFor&lt;C, B&gt;&gt;</code>. Why would a block import have a reference to another block import? Because the &quot;block import pipeline&quot; is constructed in an onion-like fashion, where one layer of block import wraps the next. In this minimal PoW node, there is only one layer to the onion. But in other nodes, including our own kitchen node, there are two layers: one for babe and one for grandpa.</p>
<h3><a class="header" href="#inherent-data-providers" id="inherent-data-providers">Inherent Data Providers</a></h3>
<p>Both the BlockImport and the <code>import_queue</code> are given an instance called <code>inherent_data_providers</code>. This object is created in a helper function defined at the beginning of <code>service.rs</code></p>
<pre><code class="language-rust ignore">pub fn build_inherent_data_providers() -&gt; Result&lt;InherentDataProviders, ServiceError&gt; {
	let providers = InherentDataProviders::new();

	providers
		.register_provider(sp_timestamp::InherentDataProvider)
		.map_err(Into::into)
		.map_err(sp_consensus::error::Error::InherentData)?;

	Ok(providers)
}
</code></pre>
<p>Anything that implements the <a href="https://substrate.dev/rustdocs/master/sp_inherents/trait.ProvideInherentData.html"><code>ProvideInherentData</code> trait</a> may be used here. The block authoring logic must supply all inherents that the runtime expects. In this case of this basic-pow chain, that is just the <a href="https://substrate.dev/rustdocs/master/sp_timestamp/trait.TimestampInherentData.html"><code>TimestampInherentData</code></a> expected by the <a href="https://substrate.dev/rustdocs/master/pallet_timestamp/index.html">timestamp pallet</a>. In order to register other inherents, you would call <code>register_provider</code> multiple times, and map errors accordingly.</p>
<h2><a class="header" href="#mining-1" id="mining-1">Mining</a></h2>
<p>We've already implemented a mining algorithm as part of our <code>Sha3Algorithm</code>, but we haven't yet told our service to actually mine with that algorithm. This is our last task in the <code>new_full</code> function.</p>
<pre><code class="language-rust ignore">if participates_in_consensus {
	let proposer = sc_basic_authorship::ProposerFactory::new(
		service.client(),
		service.transaction_pool()
	);

	// The number of rounds of mining to try in a single call
	let rounds = 500;

	let client = service.client();
	let select_chain = service.select_chain()
		.ok_or(ServiceError::SelectChainRequired)?;

	let can_author_with =
		sp_consensus::CanAuthorWithNativeVersion::new(service.client().executor().clone());

	sc_consensus_pow::start_mine(
		Box::new(block_import),
		client,
		Sha3Algorithm,
		proposer,
		None, // No preruntime digests
		rounds,
		service.network(),
		std::time::Duration::new(2, 0),
		Some(select_chain),
		inherent_data_providers.clone(),
		can_author_with,
	);
}
</code></pre>
<p>We begin by testing whether this node participates in consensus, which is to say we check whether the user wants the node to act as a miner. If this node is to be a miner, we gather references to various parts of the node that the <a href="https://substrate.dev/rustdocs/master/sc_consensus_pow/fn.start_mine.html"><code>start_mine</code> function</a> requires, and define that we will attempt 500 rounds of mining for each block before pausing. Finally we call <code>start_mine</code>.</p>
<h2><a class="header" href="#the-light-client" id="the-light-client">The Light Client</a></h2>
<p>The last thing in the <code>service.rs</code> file is constructing the <a href="https://www.parity.io/what-is-a-light-client/">light client</a>'s service. This code is quite similar to the construction of the full service.</p>
<p>Instead of using the <code>with_import_queue</code> function we used previously, we use the <code>with_import_queue_and_fprb</code> function. FPRB stand for <a href="https://substrate.dev/rustdocs/master/sc_network/config/trait.FinalityProofRequestBuilder.html"><code>FinalityProofRequestBuilder</code></a>. In chains with deterministic finality, light clients must request proofs of finality from full nodes. But in our chain, we do not have deterministic finality, so we can use the <a href="https://substrate.dev/rustdocs/master/sc_network/config/struct.DummyFinalityProofRequestBuilder.html"><code>DummyFinalityProofRequestBuilder</code></a> which does nothing except satisfying Rust's type checker.</p>
<p>Once the dummy request builder is configured, the <code>BlockImport</code> and import queue are configured exactly as they were in the full node.</p>
<h2><a class="header" href="#note-of-finality" id="note-of-finality">Note of Finality</a></h2>
<p>If we run the <code>basic-pow</code> node now, we see in console logs, that the finalized block always remains at 0.</p>
<pre><code>...
2020-03-22 12:50:09 Starting consensus session on top of parent 0x85811577d1033e918b425380222fd8c5aef980f81fa843d064d80fe027c79f5a
2020-03-22 12:50:09 Imported #189 (0x8581…9f5a)
2020-03-22 12:50:09 Prepared block for proposing at 190 [hash: 0xdd83ba96582acbed59aacd5304a9258962d1d4c2180acb8b77f725bd81461c4f; parent_hash: 0x8581…9f5a; extrinsics (1): [0x77a5…f7ad]]
2020-03-22 12:50:10 Idle (1 peers), best: #189 (0x8581…9f5a), finalized #0 (0xff0d…5cb9), ⬇ 0.2kiB/s ⬆ 0.4kiB/s
2020-03-22 12:50:15 Idle (1 peers), best: #189 (0x8581…9f5a), finalized #0 (0xff0d…5cb9), ⬇ 0 ⬆ 0
</code></pre>
<p>This is expected because Proof of Work is a consensus mechanism with probabilistic finality. This means a block is never truly finalized and can always be reverted. The further behind the blockchain head a block is, the less likely it is going to be reverted.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../3-entrees/custom-rpc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../3-entrees/manual-seal.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../3-entrees/custom-rpc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../3-entrees/manual-seal.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../.analytics/load.js"></script>
        
        <script type="text/javascript" src="../.analytics/config.js"></script>
        
        <script type="text/javascript" src="../.analytics/klaro.min.js"></script>
        

        

    </body>
</html>
