<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Local Storage - Substrate Recipes</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A Hands-On Cookbook for Aspiring Blockchain Chefs">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../../introduction.html">Introduction</a></li><li class="expanded "><a href="../../1-prepare-kitchen/index.html"><strong aria-hidden="true">1.</strong> Preparing Your Kitchen</a></li><li><ol class="section"><li class="expanded "><a href="../../1-prepare-kitchen/1-build-node.html"><strong aria-hidden="true">1.1.</strong> Building A Node</a></li><li class="expanded "><a href="../../1-prepare-kitchen/2-interact-node.html"><strong aria-hidden="true">1.2.</strong> Interacting with a Node</a></li><li class="expanded "><a href="../../1-prepare-kitchen/3-kitchen-organization.html"><strong aria-hidden="true">1.3.</strong> Kitchen Organization</a></li></ol></li><li class="expanded "><a href="../../2-appetizers/index.html"><strong aria-hidden="true">2.</strong> Appetizers</a></li><li><ol class="section"><li class="expanded "><a href="../../2-appetizers/1-hello-substrate.html"><strong aria-hidden="true">2.1.</strong> Hello Substrate</a></li><li class="expanded "><a href="../../2-appetizers/2-storage-values.html"><strong aria-hidden="true">2.2.</strong> Single Value Storage</a></li><li class="expanded "><a href="../../2-appetizers/3-errors.html"><strong aria-hidden="true">2.3.</strong> Handling Errors</a></li><li class="expanded "><a href="../../2-appetizers/4-events.html"><strong aria-hidden="true">2.4.</strong> Events Verify Execution</a></li></ol></li><li class="expanded "><a href="../../3-entrees/index.html"><strong aria-hidden="true">3.</strong> Entrees</a></li><li><ol class="section"><li class="expanded "><a href="../../3-entrees/storage-api/index.html"><strong aria-hidden="true">3.1.</strong> Runtime Storage API</a></li><li><ol class="section"><li class="expanded "><a href="../../3-entrees/storage-api/storage-maps.html"><strong aria-hidden="true">3.1.1.</strong> Storage Maps</a></li><li class="expanded "><a href="../../3-entrees/storage-api/cache.html"><strong aria-hidden="true">3.1.2.</strong> Cache Locally &gt; Storage Calls</a></li><li class="expanded "><a href="../../3-entrees/storage-api/sets-vecs-iteration.html"><strong aria-hidden="true">3.1.3.</strong> Sets, Vectors, Iteration</a></li><li class="expanded "><a href="../../3-entrees/storage-api/double.html"><strong aria-hidden="true">3.1.4.</strong> Subgroup Removal by Subkey: Double Maps</a></li><li class="expanded "><a href="../../3-entrees/storage-api/childtries.html"><strong aria-hidden="true">3.1.5.</strong> Efficient Subgroup Removal by Subkey: Child Tries</a></li><li class="expanded "><a href="../../3-entrees/storage-api/structs.html"><strong aria-hidden="true">3.1.6.</strong> Storing custom structs</a></li><li class="expanded "><a href="../../3-entrees/storage-api/ringbuffer.html"><strong aria-hidden="true">3.1.7.</strong> Ringbuffer Queue</a></li></ol></li><li class="expanded "><a href="../../3-entrees/basic-token.html"><strong aria-hidden="true">3.2.</strong> Basic Token</a></li><li class="expanded "><a href="../../3-entrees/constants.html"><strong aria-hidden="true">3.3.</strong> Configurable Constants</a></li><li class="expanded "><a href="../../3-entrees/instantiable.html"><strong aria-hidden="true">3.4.</strong> Instantiable Pallets</a></li><li class="expanded "><a href="../../3-entrees/weights.html"><strong aria-hidden="true">3.5.</strong> Weights for Resource Accounting</a></li><li class="expanded "><a href="../../3-entrees/fees.html"><strong aria-hidden="true">3.6.</strong> Transaction Fees for Economic Security</a></li><li class="expanded "><a href="../../3-entrees/charity.html"><strong aria-hidden="true">3.7.</strong> Charity and Imbalances</a></li><li class="expanded "><a href="../../3-entrees/fixed-point.html"><strong aria-hidden="true">3.8.</strong> Fixed Point Arithmetic</a></li><li class="expanded "><a href="../../3-entrees/off-chain-workers/index.html"><strong aria-hidden="true">3.9.</strong> Off-chain Workers</a></li><li><ol class="section"><li class="expanded "><a href="../../3-entrees/off-chain-workers/transactions.html"><strong aria-hidden="true">3.9.1.</strong> Transactions</a></li><li class="expanded "><a href="../../3-entrees/off-chain-workers/http-json.html"><strong aria-hidden="true">3.9.2.</strong> HTTP Fetching &amp; JSON Parsing</a></li><li class="expanded "><a href="../../3-entrees/off-chain-workers/storage.html" class="active"><strong aria-hidden="true">3.9.3.</strong> Local Storage</a></li></ol></li><li class="expanded "><a href="../../3-entrees/runtime-api.html"><strong aria-hidden="true">3.10.</strong> Runtime APIs</a></li><li class="expanded "><a href="../../3-entrees/custom-rpc.html"><strong aria-hidden="true">3.11.</strong> Custom RPCs</a></li><li class="expanded "><a href="../../3-entrees/basic-pow.html"><strong aria-hidden="true">3.12.</strong> Basic Proof of Work</a></li><li class="expanded "><a href="../../3-entrees/manual-seal.html"><strong aria-hidden="true">3.13.</strong> Manual Seal Consensus</a></li><li class="expanded "><a href="../../3-entrees/kitchen-node.html"><strong aria-hidden="true">3.14.</strong> Kitchen Node - An reusable instant seal node</a></li><li class="expanded "><a href="../../3-entrees/currency.html"><strong aria-hidden="true">3.15.</strong> Currency Types</a></li><li class="expanded "><a href="../../3-entrees/randomness.html"><strong aria-hidden="true">3.16.</strong> Generating Randomness</a></li><li class="expanded "><a href="../../3-entrees/execution-schedule.html"><strong aria-hidden="true">3.17.</strong> Execution Schedule</a></li><li class="expanded "><a href="../../3-entrees/permissioned-methods.html"><strong aria-hidden="true">3.18.</strong> Permissioned Methods</a></li><li class="expanded "><a href="../../3-entrees/testing/index.html"><strong aria-hidden="true">3.19.</strong> Testing</a></li><li><ol class="section"><li class="expanded "><a href="../../3-entrees/testing/mock.html"><strong aria-hidden="true">3.19.1.</strong> Basic Test Environments</a></li><li class="expanded "><a href="../../3-entrees/testing/common.html"><strong aria-hidden="true">3.19.2.</strong> Common Tests</a></li><li class="expanded "><a href="../../3-entrees/testing/off-chain-workers.html"><strong aria-hidden="true">3.19.3.</strong> Off-chain Worker Test Environment</a></li><li class="expanded "><a href="../../3-entrees/testing/externalities.html"><strong aria-hidden="true">3.19.4.</strong> Custom Test Environment</a></li></ol></li><li class="expanded "><a href="../../3-entrees/safemath.html"><strong aria-hidden="true">3.20.</strong> Safe Math</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="../../more-resources.html">More Resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Substrate Recipes</h1>

                        <div class="right-buttons">
                            <a href="../../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#local-storage-in-off-chain-workers" id="local-storage-in-off-chain-workers">Local Storage in Off-chain Workers</a></h1>
<p><em><a href="https://github.com/substrate-developer-hub/recipes/tree/master/pallets/offchain-demo"><code>pallets/offchain-demo</code></a></em></p>
<p>Remember we mentioned that off-chain workers (short for <strong>ocw</strong> below) cannot write directly to the on-chain storage, that is why they have to submit transactions back on-chain to modify the state.</p>
<p>Fortunately, there is also a local storage that persist across runs in off-chain workers. Storage is local within off-chain workers and not passed within network. Storage of off-chain workers is persisted across runs of off-chain workers and blockchain re-organizations.</p>
<p>Off-chain workers are asynchronously run during block import. Since ocws are not limited by how long they run, at any single instance there could be multiple ocws running, being initiated by previous block imports. See diagram below.</p>
<p><img src="/img/multiple-ocws.png" alt="More than one off-chain workers at a single instance" /></p>
<p>The storage has a similar API usage as on-chain <a href="/2-appetizers/2-storage-values.html"><code>StorageValue</code></a> with <code>get</code>, <code>set</code>, and <code>mutate</code>. <code>mutate</code> is using a <a href="https://en.wikipedia.org/wiki/Compare-and-swap"><code>compare-and-set</code></a> pattern. It compares the contents of a memory location with a given value and, only if they are the same, modifies the contents of that memory location to a new given value. This is done as a single atomic operation. The atomicity guarantees that the new value is calculated based on up-to-date information; if the value had been updated by another thread in the meantime, the write would fail.</p>
<p>In this recipe, we will add a cache and lock over our previous <a href="./http-json.html">http fetching example</a>. If the cached value existed, we will return using the cached value. Otherwise we acquire the lock and then fetch from github public API and save it to the cache.</p>
<h2><a class="header" href="#setup" id="setup">Setup</a></h2>
<p>First, include the relevant module.</p>
<p>src: <code>offchain-demo/src/lib.rs</code></p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>use sp_runtime::{
	// ...
	offchain::{storage::StorageValueRef},
	// ...
}
<span class="boring">}
</span></code></pre></pre>
<p>Then, in the <code>fetch_if_needed()</code> function, we first define a storage reference used by the off-chain worker.</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn fetch_if_needed() -&gt; Result&lt;(), Error&lt;T&gt;&gt; {

	// Start off by creating a reference to Local Storage value.
	// Since the local storage is common for all offchain workers, it's a good practice
	// to prepend our entry with the pallet name.
	let storage = StorageValueRef::persistent(b&quot;offchain-demo::gh-info&quot;);
	let s_lock = StorageValueRef::persistent(b&quot;offchain-demo::lock&quot;);
	// ...
}
<span class="boring">}
</span></code></pre></pre>
<p>Looking at the <a href="https://substrate.dev/rustdocs/v2.0.0-alpha.6/sp_runtime/offchain/storage/struct.StorageValueRef.html">API doc</a>, we see there are two type of StorageValueRef, created via <code>::persistent()</code> and <code>::local()</code>. <code>::local()</code> is not fully implemented yet and <code>::persistent()</code> is enough for this use cases. We passed in a key as our storage key. As storage keys are namespaced globally, a good practice would be to prepend our pallet name in front of our storage key.</p>
<h2><a class="header" href="#access" id="access">Access</a></h2>
<p>Once we have the storage reference, we can access the storage via <code>get</code>, <code>set</code>, and <code>mutate</code>. Let's demonstrate the <code>mutate</code> function as the usage of the remaining two functions are pretty self-explanatory.</p>
<p>First we fetch to see if github info has been fetched and cached. If yes, we return early.</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn fetch_if_needed() -&gt; Result&lt;(), Error&lt;T&gt;&gt; {
	// ...
	if let Some(Some(gh_info)) = s_info.get::&lt;GithubInfo&gt;() {
		// gh-info has already been fetched. Return early.
		debug::info!(&quot;cached gh-info: {:?}&quot;, gh_info);
		return Ok(());
	}
	// ...
}
<span class="boring">}
</span></code></pre></pre>
<p>As with general on-chain storage, if we have a storage access pattern of <strong>get-check-set</strong>, it is a good indicator we should use <code>mutate</code>. This makes sure that multiple off-chain workers running concurrently does not modify the same storage entry.</p>
<p>We then try to acquire the lock in order to fetch github info.</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn fetch_if_needed() -&gt; Result&lt;(), Error&lt;T&gt;&gt; {
	//...
	// We are implementing a mutex lock here with `s_lock`
	let res: Result&lt;Result&lt;bool, bool&gt;, Error&lt;T&gt;&gt; = s_lock.mutate(|s: Option&lt;Option&lt;bool&gt;&gt;| {
		match s {
			// `s` can be one of the following:
			//   `None`: the lock has never been set. Treated as the lock is free
			//   `Some(None)`: unexpected case, treated it as AlreadyFetch
			//   `Some(Some(false))`: the lock is free
			//   `Some(Some(true))`: the lock is held

			// If the lock has never been set or is free (false), return true to execute `fetch_n_parse`
			None | Some(Some(false)) =&gt; Ok(true),

			// Otherwise, someone already hold the lock (true), we want to skip `fetch_n_parse`.
			// Covering cases: `Some(None)` and `Some(Some(true))`
			_ =&gt; Err(&lt;Error&lt;T&gt;&gt;::AlreadyFetched),
		}
	});
	//...
}
<span class="boring">}
</span></code></pre></pre>
<p>We use the <code>mutate</code> function to get and set the lock value, taking advantages of its compare-and-set access pattern. If the lock is being held by another ocw (with <code>s</code> equals value of <code>Some(Some(true))</code>), we return an error indicating the fetching is done by another ocw.</p>
<p>The return value of the <code>mutate</code> has a type of <code>Result&lt;Result&lt;T, T&gt;, E&gt;</code>, to indicate one of the following cases:</p>
<ul>
<li><code>Ok(Ok(T))</code> - the value has been successfully set in the <code>mutate</code> closure and saved to the storage.</li>
<li><code>Ok(Err(T))</code> - the value has been successfully set in the <code>mutate</code> closure, but failed to save to the storage.</li>
<li><code>Err(_)</code> - the value has <strong>NOT</strong> been set successfully in the <code>mutate</code> closure.</li>
</ul>
<p>Now we check the returned value of the <code>mutate</code> function. If fetching is done by another ocw (returning <code>Err(&lt;Error&lt;T&gt;&gt;)</code>), or cannot acquire the lock (returning <code>Ok(Err(true))</code>), we skip the fetching.</p>
<pre><pre class="playpen"><code class="language-rust">
<span class="boring">#![allow(unused_variables)]
</span><span class="boring">fn main() {
</span>fn fetch_if_needed() -&gt; Result&lt;(), Error&lt;T&gt;&gt; {
	// ...
	// Cases of `res` returned result:
	//   `Err(&lt;Error&lt;T&gt;&gt;)` - lock is held, so we want to skip `fetch_n_parse` function.
	//   `Ok(Err(true))` - Another ocw is writing to the storage while we set it,
	//                     we also skip `fetch_n_parse` in this case.
	//   `Ok(Ok(true))` - successfully acquire the lock, so we run `fetch_n_parse`
	if let Ok(Ok(true)) = res {
		match Self::fetch_n_parse() {
			Ok(gh_info) =&gt; {
				// set gh-info into the storage and release the lock
				s_info.set(&amp;gh_info);
				s_lock.set(&amp;false);

				debug::info!(&quot;fetched gh-info: {:?}&quot;, gh_info);
			},
			Err(err) =&gt; {
				// release the lock
				s_lock.set(&amp;false);
				return Err(err);
			}
		}
	}
	Ok(())
}
<span class="boring">}
</span></code></pre></pre>
<p>Finally, whether the <code>fetch_n_parse()</code> function success or not, we release the lock by setting it to <code>false</code>.</p>
<h2><a class="header" href="#reference" id="reference">Reference</a></h2>
<ul>
<li><a href="https://substrate.dev/rustdocs/master/sp_runtime/offchain/storage/struct.StorageValueRef.html"><code>StorageValueRef</code> API doc</a></li>
<li><a href="https://github.com/paritytech/substrate/tree/master/frame/example-offchain-worker"><code>example-offchain-worker</code> pallet in Substrate repo</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../3-entrees/off-chain-workers/http-json.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../3-entrees/runtime-api.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../../3-entrees/off-chain-workers/http-json.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../../3-entrees/runtime-api.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../.analytics/load.js"></script>
        
        <script type="text/javascript" src="../../.analytics/config.js"></script>
        
        <script type="text/javascript" src="../../.analytics/klaro.min.js"></script>
        

        

    </body>
</html>
